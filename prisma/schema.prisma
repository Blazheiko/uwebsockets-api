// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  name      String   @db.VarChar(100)
  email     String   @unique
  password  String   @map("password")
  phone     String?  @unique @db.VarChar(20)
  isAdmin   Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  contacts            ContactList[] @relation("UserContacts")
  contactOf           ContactList[] @relation("ContactOfUser")
  sentMessages        Message[]     @relation("SentMessages")
  receivedMessages    Message[]     @relation("ReceivedMessages")
  createdInvitations  Invitation[]  @relation("CreatedInvitations")
  receivedInvitations Invitation[]  @relation("ReceivedInvitations")
  notes               Notes[]       @relation("UserNotes")
  calendarEvents      Calendar[]    @relation("UserCalendarEvents")
  tasks               Task[]        @relation("UserTasks")
  projects            Project[]     @relation("UserProjects")

  @@map("users")
}

model ContactList {
  id          Int      @id @default(autoincrement())
  userId      Int      @map("user_id")
  contactId   Int      @map("contact_id")
  rename      String?  @db.VarChar(100)
  status      String   @default("pending") // pending, accepted, blocked, favorite
  unreadCount Int      @default(0) @map("unread_count")
  lastMessageId Int?   @map("last_message_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  user    User @relation("UserContacts", fields: [userId], references: [id])
  contact User @relation("ContactOfUser", fields: [contactId], references: [id])
  lastMessage Message? @relation("LastMessage", fields: [lastMessageId], references: [id])

  @@unique([userId, contactId])
  @@map("contact_list")
}

enum MessageType {
  TEXT
  IMAGE
  VIDEO
  AUDIO
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model Message {
  id         Int         @id @default(autoincrement())
  senderId   Int         @map("sender_id")
  receiverId Int         @map("receiver_id")
  type       MessageType @default(TEXT)
  content    String      @db.Text
  src        String? // URL или путь к файлу для медиа-сообщений
  isRead     Boolean     @default(false) @map("is_read")
  createdAt  DateTime    @default(now()) @map("created_at")
  updatedAt  DateTime    @updatedAt @map("updated_at")

  // Relations
  sender   User @relation("SentMessages", fields: [senderId], references: [id])
  receiver User @relation("ReceivedMessages", fields: [receiverId], references: [id])
  contactList  ContactList[] @relation("LastMessage")

  @@map("messages")
}

model Invitation {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  name      String   @db.VarChar(100)
  userId    Int      @map("user_id")
  invitedId Int?     @map("invited_id")
  isUsed    Boolean  @default(false) @map("is_used")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user    User? @relation("CreatedInvitations", fields: [userId], references: [id])
  invited User? @relation("ReceivedInvitations", fields: [invitedId], references: [id])

  @@map("invitations")
}

model Notes {
  id          Int      @id @default(autoincrement())
  title       String   @db.VarChar(255)
  description String   @db.Text
  userId      Int      @map("user_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  user   User         @relation("UserNotes", fields: [userId], references: [id])
  photos NotesPhoto[] @relation("NotePhotos")

  @@map("notes")
}

model NotesPhoto {
  id        Int      @id @default(autoincrement())
  noteId    Int      @map("note_id")
  src       String   @db.VarChar(500) // URL или путь к файлу фотографии
  filename  String?  @db.VarChar(255) // Оригинальное имя файла
  size      Int?     // Размер файла в байтах
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  note Notes @relation("NotePhotos", fields: [noteId], references: [id], onDelete: Cascade)

  @@map("notes_photos")
}

model Calendar {
  id          Int      @id @default(autoincrement())
  title       String   @db.VarChar(255)
  description String   @db.Text
  startTime   DateTime @map("start_time")
  endTime     DateTime @map("end_time")
  userId      Int      @map("user_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation("UserCalendarEvents", fields: [userId], references: [id])

  @@map("calendar")
}

model Task {
  id             Int          @id @default(autoincrement())
  title          String       @db.VarChar(255)
  description    String?      @db.Text
  userId         Int          @map("user_id")
  projectId      Int?         @map("project_id")
  status         TaskStatus   @default(TODO)
  priority       TaskPriority @default(MEDIUM)
  progress       Int          @default(0) // 0-100 процентов
  isCompleted    Boolean      @default(false) @map("is_completed")
  tags           String?      @db.VarChar(500) // Теги для дополнительной категоризации (не для проектов)
  dueDate        DateTime?    @map("due_date")
  startDate      DateTime?    @map("start_date")
  estimatedHours Float?       @map("estimated_hours")
  actualHours    Float?       @map("actual_hours")
  parentTaskId   Int?         @map("parent_task_id")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  // Relations
  user       User     @relation("UserTasks", fields: [userId], references: [id])
  project    Project? @relation("ProjectTasks", fields: [projectId], references: [id])
  parentTask Task?    @relation("SubTasks", fields: [parentTaskId], references: [id])
  subTasks   Task[]   @relation("SubTasks")

  @@map("tasks")
}

model Project {
  id          Int      @id @default(autoincrement())
  name        String   @db.VarChar(255)
  description String?  @db.Text
  color       String?  @db.VarChar(7) // HEX цвет для UI (#FF5733)
  isActive    Boolean  @default(true) @map("is_active")
  userId      Int      @map("user_id")
  startDate   DateTime? @map("start_date")
  endDate     DateTime? @map("end_date")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  user  User   @relation("UserProjects", fields: [userId], references: [id])
  tasks Task[] @relation("ProjectTasks")

  @@map("projects")
}
